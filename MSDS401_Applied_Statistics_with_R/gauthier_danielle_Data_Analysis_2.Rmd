---
title: "Data Analysis Assignment #2 (75 points total)"
author: "Gauthier, Danielle"
output:
  html_document: default
---

```{r setup, include = FALSE}
# DO NOT ADD OR REVISE CODE HERE
knitr::opts_chunk$set(echo = FALSE, eval = TRUE)

```

##Data Analysis #2

```{r analysis_setup1, message = FALSE, warning = FALSE}

# Perform the following steps to start the assignment.
 
# 1) Load/attach the following packages via library():  flux, ggplot2, gridExtra, moments, rockchalk, car.
# NOTE:  packages must be installed via install.packages() before they can be loaded.

library(dplyr)
library(flux)
library(ggplot2)
library(gridExtra)
library(knitr)
library(rockchalk)
library(tidyverse)

# 2) Use the "mydata.csv" file from Assignment #1 or use the file posted on the course site.  Reading
# the files into R will require sep = "" or sep = " " to format data properly.  Use str() to check file
# structure.

mydata <- read.csv("mydata.csv", sep = ",", stringsAsFactors = TRUE)
# mydata <- read.csv(file.path("c:...", "mydata.csv"), sep = ",")
# mydata <- read.csv(file.path("c:/Rabalone/", "mydata.csv"), sep = ",")

str(mydata)

```

### Test Items starts from here - There are 10 sections - total of 75 points ##############

***#### Section 1: (5 points) ####***

(1)(a) Form a histogram and QQ plot using RATIO. Calculate skewness and kurtosis using 'rockchalk.' Be aware that with 'rockchalk', the kurtosis value has 3.0 subtracted from it which differs from the 'moments' package. 

```{r Part_1a, fig.width = 12}
# Histogram
qplot(mydata$RATIO, geom="histogram", colour = I("blue"), xlab = "Ratio of SHUCK to VOLUME", ylab= "Count of Abalones", main = "Histogram of Abalones SHUCK to VOLUME Ratio Distribution")

# QQ plot
qqnorm(mydata$RATIO,
       main = "QQ Plot of RATIO",
       col = "blue",
       pch = 19)
qqline(mydata$RATIO, col = "red")

# Skewness and kurtosis
summary_stats <- summarize(mydata$RATIO, digits = 4)
print(summary_stats)

```
(1)(b) Tranform RATIO using *log10()* to create L_RATIO (Kabacoff Section 8.5.2, p. 199-200). Form a histogram and QQ plot using L_RATIO. Calculate the skewness and kurtosis. Create a boxplot of L_RATIO differentiated by CLASS.

```{r Part_1b, fig.width = 12, fig.height = 8}

mydata$L_RATIO <- log10(mydata$RATIO)

# Histogram
ggplot(mydata, aes(x = L_RATIO)) +
  geom_histogram(bins = 30, color = "grey20", fill = "steelblue") +
  labs(
    title = "Histogram of log10(RATIO)",
    x = "log10(RATIO = SHUCK / VOLUME)",
    y = "Count"
  ) +
  theme_minimal()

# QQ plot of L_RATIO
ggplot(mydata, aes(sample = L_RATIO)) +
  stat_qq(color = "steelblue", alpha = 0.8) +
  stat_qq_line(color = "firebrick", linewidth = 1) +
  labs(
    title = "QQ Plot of log10(RATIO)",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_minimal()

# Skewness & kurtosis (rockchalk)
summary_stats <- summarize(mydata$L_RATIO, digits = 4, quantile.type = 7, na.rm = TRUE)
print(summary_stats)

# Boxplot of L_RATIO by CLASS
ggplot(mydata, aes(x = CLASS, y = L_RATIO, fill = CLASS)) +
  geom_boxplot(outlier.alpha = 0.6) +
  labs(
    title = "log10(RATIO) by CLASS",
    x = "CLASS",
    y = "log10(RATIO)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

(1)(c) Test the homogeneity of variance across classes using *bartlett.test()* (Kabacoff Section 9.2.2, p. 222). 

```{r Part_1c}
bartlett_test_result <- bartlett.test(L_RATIO ~ CLASS, data = mydata)
bartlett_test_result

bartlett_test_result <- bartlett.test(RATIO ~ CLASS, data = mydata)
bartlett_test_result
```

**Essay Question: Based on steps 1.a, 1.b and 1.c, which variable RATIO or L_RATIO exhibits better conformance to a normal distribution with homogeneous variances across age classes?  Why?** 

***Answer: L_RATIO exhibits better conformance to a normal distribution than RATIO. The log10 transformation reduces skewness, bringing it much closer to symmetry (only ~9% off from zero skewness). The QQ plot of L_RATIO shows points more closely aligned with the diagonal, and its histogram is more bell-shaped compared to RATIO. While both variables still have positive kurtosis, meaning heavier tails than the normal distribution, L_RATIO’s kurtosis is milder, indicating fewer extreme deviations. In addition, Bartlett’s test indicates that L_RATIO provides more homogeneous variances across age classes than RATIO. For L_RATIO, Bartlett’s test produced p = 0.527, which is well above 0.05. This means we fail to reject the null hypothesis of equal variances, so the assumption of homogeneity of variance across age classes is supported. Taken together, these results suggest that L_RATIO better satisfies the assumptions of normality and variance homogeneity required for many statistical analyses.***


***#### Section 2 (10 points) ####***

(2)(a) Perform an analysis of variance with *aov()* on L_RATIO using CLASS and SEX as the independent variables (Kabacoff chapter 9, p. 212-229). Assume equal variances. Perform two analyses. First, fit a model with the interaction term CLASS:SEX. Then, fit a model without CLASS:SEX. Use *summary()* to obtain the analysis of variance tables (Kabacoff chapter 9, p. 227).

```{r Part_2a}

# Model 1: With interaction term CLASS:SEX
anova_interaction <- aov(L_RATIO ~ CLASS * SEX, data = mydata)
summary(anova_interaction)

# Model 2: Without interaction term CLASS:SEX
anova_main <- aov(L_RATIO ~ CLASS + SEX, data = mydata)
summary(anova_main)


```

**Essay Question:  Compare the two analyses.  What does the non-significant interaction term suggest about the relationship between L_RATIO and the factors CLASS and SEX?**

***Answer: When comparing the two analyses, the results are very similar. In both models, CLASS and SEX are statistically significant predictors of L_RATIO (p < 0.0014). This indicates that both age class and sex independently influence variation in L_RATIO. The interaction term CLASS:SEX, however, is not statistically significant (p ≈ 0.867). This suggests that the effect of CLASS on L_RATIO does not depend on SEX, and likewise, the effect of SEX does not vary across CLASS. In other words, the relationship between L_RATIO and CLASS is consistent for both sexes, and the relationship between L_RATIO and SEX is consistent across classes. Because the interaction is non-significant, the simpler model without the interaction CLASS + SEX is preferred.***

(2)(b) For the model without CLASS:SEX (i.e. an interaction term), obtain multiple comparisons with the *TukeyHSD()* function. Interpret the results at the 95% confidence level (*TukeyHSD()* will adjust for unequal sample sizes). 

```{r Part_2b}
tukey_results <- TukeyHSD(anova_main, conf.level = 0.95)
print(tukey_results)

```

**Additional Essay Question:  first, interpret the trend in coefficients across age classes. What is this indicating about L_RATIO?  Second, do these results suggest male and female abalones can be combined into a single category labeled as 'adults?' If not, why not?**

***Answer: The TukeyHSD results show a clear declining trend of p-value in L_RATIO across age classes, indicating that younger abalones have proportionally higher shuck-to-volume ratios than older ones. This confirms that age strongly influences L_RATIO. Regarding SEX, Males and Females show no significant difference in mean L_RATIO, suggesting they could be combined into a single Adult category. However, Infants differ significantly from both groups, meaning they should remain distinct.***


***####  Section 3: (10 points) ####***

(3)(a1) Here, we will combine "M" and "F" into a new level, "ADULT". The code for doing this is given to you. For (3)(a1), all you need to do is execute the code as given.

```{r Part_3a1}
# Here, we show how to define the new variable TYPE using only base R functions:

mydata$TYPE <- factor(ifelse(mydata$SEX == "I", "I", "ADULT"))
table(mydata$TYPE)


```

(3)(a2)  Present side-by-side histograms of VOLUME. One should display infant volumes and, the other, adult volumes. 

```{r Part_3a2, fig.width = 12}
ggplot(mydata, aes(x = VOLUME, fill = TYPE)) +
  geom_histogram(color = "blue", alpha = 0.8, boundary = 0) +
  facet_wrap(~ TYPE, nrow = 1) +
  labs(title = "VOLUME by TYPE: Infants vs Adults", x = "Volume", y = "Count of Abalones") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right")

```


**Essay Question: Compare the histograms.  How do the distributions differ? Are there going to be any difficulties separating infants from adults based on VOLUME?**

***Answer: Volume is a useful but imperfect separator. While it shows distinct tendencies (infants smaller, adults larger), the overlap zone means you’d misclassify some abalones if you relied on volume alone. Additional variables might improve accuracy.***

(3)(b) Create a scatterplot of SHUCK versus VOLUME and a scatterplot of their base ten logarithms, labeling the variables as L_SHUCK and L_VOLUME. Please be aware the variables, L_SHUCK and L_VOLUME, present the data as orders of magnitude (i.e. VOLUME = 100 = 10^2 becomes L_VOLUME = 2). Use color to differentiate CLASS in the plots. Repeat using color to differentiate by TYPE. 

```{r Part_3b, fig.width = 12, fig.height = 8}

library(gridExtra)

# Create log-transformed variables
mydata$L_SHUCK <- log10(mydata$SHUCK)
mydata$L_VOLUME <- log10(mydata$VOLUME)

# Scatterplots 
# 1) raw, colored by CLASS
p1 <- ggplot(mydata, aes(VOLUME, SHUCK, color = CLASS)) +
  geom_point(alpha = 0.65) +
  labs(title = "Raw: SHUCK vs VOLUME (by CLASS)", x = "VOLUME", y = "SHUCK") +
  theme_minimal()

# 2) log10, colored by CLASS
p2 <- ggplot(mydata, aes(L_VOLUME, L_SHUCK, color = CLASS)) +
  geom_point(alpha = 0.65) +
  labs(title = "Log10: L_SHUCK vs L_VOLUME (by CLASS)",
       x = "log10(VOLUME)", y = "log10(SHUCK)") +
  theme_minimal()

# 3) raw, colored by TYPE
p3 <- ggplot(mydata, aes(VOLUME, SHUCK, color = TYPE)) +
  geom_point(alpha = 0.65) +
  labs(title = "Raw: SHUCK vs VOLUME (by TYPE)", x = "VOLUME", y = "SHUCK") +
  theme_minimal()

# 4) log10, colored by TYPE
p4 <- ggplot(mydata, aes(L_VOLUME, L_SHUCK, color = TYPE)) +
  geom_point(alpha = 0.65) +
  labs(title = "Log10: L_SHUCK vs L_VOLUME (by TYPE)",
       x = "log10(VOLUME)", y = "log10(SHUCK)") +
  theme_minimal()

grid.arrange(p1, p2, p3, p4, ncol = 2)
```

**Additional Essay Question:  Compare the two scatterplots. What effect(s) does log-transformation appear to have on the variability present in the plot?  What are the implications for linear regression analysis? Where do the various CLASS levels appear in the plots? Where do the levels of TYPE appear in the plots?**

***Answer: The log-transformation of SHUCK and VOLUME substantially reduces the heteroscedasticity (unequal spread) that is present in the raw scatterplots. In the raw plots, the variance in SHUCK increases with larger VOLUME values, producing a “fan-shaped” spread. After the log10 transformation, the data cloud becomes more evenly distributed across the range, producing a straighter linear trend with more constant variance.Implications for regression analysis: In the raw data, heteroscedasticity would violate the assumptions of ordinary least squares regression, potentially leading to inefficient estimates and biased inference. After log-transformation, the residual variance is stabilized, making linear regression assumptions more appropriate. This allows for more reliable hypothesis tests and confidence intervals. Location of CLASS levels: In the raw plots colored by CLASS, younger classes (A1, A2) cluster toward the lower-left corner, with smaller SHUCK and VOLUME values. Older classes (A4, A5) extend toward the upper-right, reflecting larger body sizes. After log-transformation, these classes remain ordered along the regression line. Location of TYPE levels: In the TYPE plots, infants (I) are located toward the lower-left, while adults occupy the majority of the upper and central portions of the plot. After log transformation, the separation between infants and adults is clearer: infants cluster tightly at lower log values, while adults span a broader range. Conclusion: The log-transformation improves model fit by stabilizing variance and highlighting proportional differences. It clarifies the relative positions of both CLASS and TYPE, making regression analysis more interpretable.***


***####   Section 4: (5 points) ####***

(4)(a1) Since abalone growth slows after class A3, infants in classes A4 and A5 are considered mature and candidates for harvest. You are given code in (4)(a1) to reclassify the infants in classes A4 and A5 as ADULTS. 

```{r Part_4a1}

mydata$TYPE[mydata$CLASS == "A4" | mydata$CLASS == "A5"] <- "ADULT"
table(mydata$TYPE)

```

(4)(a2) Regress L_SHUCK as the dependent variable on L_VOLUME, CLASS and TYPE (Kabacoff Section 8.2.4, p. 178-186, the Data Analysis Video #2 and Black Section 14.2). Use the multiple regression model: L_SHUCK ~ L_VOLUME + CLASS + TYPE. Apply *summary()* to the model object to produce results.

```{r Part_4a2}

fit <- lm(L_SHUCK ~ L_VOLUME + CLASS + TYPE, data = mydata)
summary(fit)
```

**Essay Question:  Interpret the trend in CLASS levelcoefficient estimates? (Hint:  this question is not asking if the estimates are statistically significant. It is asking for an interpretation of the pattern in these coefficients, and how this pattern relates to the earlier displays).**

***Answer: The coefficients for CLASS relative to the baseline group, A1, show a clear, downward trend: A2 at –0.018, A3 at –0.047, A4 at –0.076, and A5 at –0.117. This pattern means that, after adjusting for L_VOLUME and TYPE, abalones in higher CLASS groups (older aged) tend to have progressively lower values of L_SHUCK relative to their VOLUME. As CLASS increases from A1 to A5, the ratio of SHUCK to VOLUME decreases on the log scale. This indicates that, even when comparing abalones of the same volume, older classes return proportionally smaller shuck weights. In earlier histograms and boxplots of RATIO and L_RATIO by CLASS, we saw that older age classes clustered lower, indicating a declining trend in the shuck-to-volume ratio. The regression coefficients confirm this same decline, but now within a model that accounts for volume scaling (via log transformation) and TYPE. The regression result quantifies what was visible in the exploratory plots: age class differences are not random, but instead follow a consistent downward slope across classes. The CLASS coefficient pattern reflects a trend: as abalones age, their meat yield relative to size diminishes. This pattern, already visible in the visual displays, is now captured numerically and confirmed through regression.***

**Additional Essay Question:  Is TYPE an important predictor in this regression? (Hint:  This question is not asking if TYPE is statistically significant, but rather how it compares to the other independent variables in terms of its contribution to predictions of L_SHUCK for harvesting decisions.)  Explain your conclusion.**

***Answer: In the regression, TYPE (Infant vs. Adult) has a coefficient of about –0.021 for Infant (I) compared to Adults, with a relatively small magnitude compared to the effects of CLASS and L_VOLUME. L_VOLUME is by far the dominant predictor: its coefficient is ~1.00, and it explains nearly all of the variability in L_SHUCK. This makes sense, since shuck weight scales almost directly with volume. CLASS effects are larger than TYPE’s, ranging from –0.018 (A2) down to –0.117 (A5). These differences accumulate across age groups and reflect a clear trend that affects yield. TYPE does adjust predictions slightly (Infants have proportionally less shuck weight relative to adults of the same volume), but its effect size is modest compared to L_VOLUME and CLASS. If the goal is to predict absolute shuck yield, TYPE contributes only a minor refinement to predictions beyond volume and age class. Volume and class information provide the most useful predictors for harvesting, since they capture the bulk of the variability and the systematic decline with age. TYPE could still be useful as a secondary adjustment factor, but on its own it would not be sufficient to guide harvesting decisions.***

-----

The next two analysis steps involve an analysis of the residuals resulting from the regression model in (4)(a) (Kabacoff Section 8.2.4, p. 178-186, the Data Analysis Video #2).

-----

***#### Section 5: (5 points) ####***

(5)(a) If "model" is the regression object, use model$residuals and construct a histogram and QQ plot. Compute the skewness and kurtosis. Be aware that with 'rockchalk,' the kurtosis value has 3.0 subtracted from it which differs from the 'moments' package. 

```{r Part_5am, fig.width = 12}
# Extract residuals
resid_vals <- fit$residuals

# Histogram of residuals
hist(resid_vals,
     main = "Histogram of Residuals",
     xlab = "Residuals",
     col = "lightblue", border = "black")

# QQ plot of residuals
qqnorm(resid_vals,
       main = "QQ Plot of Residuals",
       col = "blue")
qqline(resid_vals, col = "red")

# Skewness and Kurtosis
skew_val <- skewness(resid_vals)
kurt_val <- kurtosis(resid_vals)

cat("Skewness:", round(skew_val, 4), "\n")
cat("Kurtosis:", round(kurt_val, 4))
```

(5)(b) Plot the residuals versus L_VOLUME, coloring the data points by CLASS and, a second time, coloring the data points by TYPE. Keep in mind the y-axis and x-axis may be disproportionate which will amplify the variability in the residuals. Present boxplots of the residuals differentiated by CLASS and TYPE (These four plots can be conveniently presented on one page using *par(mfrow..)* or *grid.arrange()*. Test the homogeneity of variance of the residuals across classes using *bartlett.test()* (Kabacoff Section 9.3.2, p. 222).  

```{r Part_5b, fig.width = 12, fig.height = 8}

mydata$resid <- residuals(fit)

# Make symmetric y-limits for visual comparison
ymax <- max(abs(mydata$resid), na.rm = TRUE)

# Scatter: 
# residuals vs L_VOLUME colored by CLASS
p1 <- ggplot(mydata, aes(x = L_VOLUME, y = resid, color = CLASS)) +
  geom_hline(yintercept = 0, color = "blue") +
  geom_point(alpha = 0.6) +
  scale_y_continuous(limits = c(-ymax, ymax)) +
  labs(title = "Residuals vs L_VOLUME (by CLASS)", x = "L_VOLUME", y = "Residuals") +
  theme_minimal()

# residuals vs L_VOLUME colored by TYPE
p2 <- ggplot(mydata, aes(x = L_VOLUME, y = resid, color = TYPE)) +
  geom_hline(yintercept = 0, color = "blue") +
  geom_point(alpha = 0.6) +
  scale_y_continuous(limits = c(-ymax, ymax)) +
  labs(title = "Residuals vs L_VOLUME (by TYPE)", x = "L_VOLUME", y = "Residuals") +
  theme_minimal()

# Boxplot: 
# residuals by CLASS
p3 <- ggplot(mydata, aes(x = CLASS, y = resid, fill = CLASS)) +
  geom_hline(yintercept = 0, color = "blue") +
  geom_boxplot(outlier.alpha = 0.5) +
  labs(title = "Residuals by CLASS", x = "CLASS", y = "Residuals") +
  theme_minimal() +
  theme(legend.position = "none")

# residuals by TYPE
p4 <- ggplot(mydata, aes(x = TYPE, y = resid, fill = TYPE)) +
  geom_hline(yintercept = 0, color = "blue") +
  geom_boxplot(outlier.alpha = 0.5) +
  labs(title = "Residuals by TYPE", x = "TYPE", y = "Residuals") +
  theme_minimal() +
  theme(legend.position = "none")

# Arrange 2x2 on one page
grid.arrange(p1, p2, p3, p4, ncol = 2)

# Homogeneity of variance across classes
bartlett_out <- bartlett.test(resid ~ CLASS, data = mydata)
bartlett_out
```

**Essay Question:  What is revealed by the displays and calculations in (5)(a) and (5)(b)? Does the model 'fit'?  Does this analysis indicate that L_VOLUME, and ultimately VOLUME, might be useful for harvesting decisions? Discuss.**  

***Answer: The displays and calculations suggest that the regression model fits the data very well. The histogram of residuals is approximately bell-shaped, and the QQ plot shows only minor deviations in the tails (caution when extrapolating to extreme values). The skewness (-0.0595) is very close to 0, and the kurtosis (0.3433) is only slightly above 0, indicating near-normal residuals with only mild heavy tails. This supports the assumption of normally distributed errors. Both the residuals vs. fitted plots (colored by CLASS and TYPE) show that residuals are evenly spread around zero with no strong funnel shape. The Bartlett test across CLASS (p = 0.4498) confirms homogeneity of variance — residual spread is consistent across classes. The residual standard error is low, and the R² reported earlier (~0.95) indicates the model explains most of the variability in L_SHUCK. This suggests that the model predictions are very reliable. Since L_VOLUME is the main predictor and residuals are well-behaved, VOLUME, and its log transformation, appears to be a useful and stable predictor for SHUCK weight. This means managers can use measurements of volume to make informed decisions about abalone harvesting. The stability across CLASS and TYPE strengthens confidence that predictions are not strongly biased by age.***

-----

Harvest Strategy:

There is a tradeoff faced in managing abalone harvest. The infant population must be protected since it represents future harvests. On the other hand, the harvest should be designed to be efficient with a yield to justify the effort. This assignment will use VOLUME to form binary decision rules to guide harvesting. If VOLUME is below a "cutoff" (i.e. a specified volume), that individual will not be harvested. If above, it will be harvested. Different rules are possible.The Management needs to make a decision to implement 1 rule that meets the business goal.

The next steps in the assignment will require consideration of the proportions of infants and adults harvested at different cutoffs. For this, similar "for-loops" will be used to compute the harvest proportions. These loops must use the same values for the constants min.v and delta and use the same statement "for(k in 1:10000)."  Otherwise, the resulting infant and adult proportions cannot be directly compared and plotted as requested. Note the example code supplied below.

-----

***#### Section 6: (5 points) ####***

(6)(a) A series of volumes covering the range from minimum to maximum abalone volume will be used in a "for loop" to determine how the harvest proportions change as the "cutoff" changes. Code for doing this is provided.

```{r Part_6a}

idxi <- mydata$TYPE == "I"
idxa <- mydata$TYPE == "ADULT"

max.v <- max(mydata$VOLUME)
min.v <- min(mydata$VOLUME)
delta <- (max.v - min.v)/10000
prop.infants <- numeric(10000)
prop.adults <- numeric(10000)
volume.value <- numeric(10000)

total.infants <- sum(idxi)  
total.adults <- sum(idxa)

for (k in 1:10000) { 
	value <- min.v + k*delta
	volume.value[k] <- value
	prop.infants[k] <- sum(mydata$VOLUME[idxi] <= value)/total.infants
	prop.adults[k] <-  sum(mydata$VOLUME[idxa] <= value)/total.adults
}

```

(6)(b) Our first "rule" will be protection of all infants. We want to find a volume cutoff that protects all infants, but gives us the largest possible harvest of adults. We can achieve this by using the volume of the largest infant as our cutoff. You are given code below to identify the largest infant VOLUME and to return the proportion of adults harvested by using this cutoff. You will need to modify this latter code to return the proportion of infants harvested using this cutoff. Remember that we will harvest any individual with VOLUME greater than our cutoff.

```{r Part_6b}
# Largest infant volume (cutoff)
(max_inf_vol <- max(mydata$VOLUME[mydata$TYPE == "I"]))  # [1] 526.6383

# Proportion of adults harvested
prop_adults_harvested <- sum(mydata$VOLUME[mydata$TYPE == "ADULT"] > max_inf_vol) /
  total.adults  # [1] 0.2476573

# Add code to calculate the proportion of infants harvested
prop_infants_harvested <- sum(mydata$VOLUME[idxi] > max_inf_vol) / total.infants

prop_adults_harvested
prop_infants_harvested

# If we use the largest infant volume, we harvest approximately 24.8% of adults and 0%,
# as expected, of infants.

```

(6)(c) Our next approaches will look at what happens when we use the median infant and adult harvest VOLUMEs. Using the median VOLUMEs as our cutoffs will give us (roughly) 50% harvests. We need to identify the median volumes and calculate the resulting infant and adult harvest proportions for both.

```{r Part_6c}
# Add code to determine the median infant volume:
median_inf_vol <- median(mydata$VOLUME[idxi])

# Add code to calculate the proportion of infants harvested
prop_inf_harvest_infcut <- sum(mydata$VOLUME[idxi] > median_inf_vol) / total.infants

# Add code to calculate the proportion of adults harvested
prop_adult_harvest_infcut <- sum(mydata$VOLUME[idxa] > median_inf_vol) / total.adults

# If we use the median infant volume as our cutoff, we harvest almost 50% of our infants
# and a little more than 93% of our adults.
median_inf_vol
prop_inf_harvest_infcut
prop_adult_harvest_infcut

# Add code to determine the median adult volume:
median_adult_vol <- median(mydata$VOLUME[idxa])

# Add code to calculate the proportion of infants harvested
prop_inf_harvest_adultcut <- sum(mydata$VOLUME[idxi] > median_adult_vol) / total.infants

# Add code to calculate the proportion of adults harvested
prop_adult_harvest_adultcut <- sum(mydata$VOLUME[idxa] > median_adult_vol) / total.adults

# If we use the median adult volume as our cutoff, we harvest almost 50% of adults
# and approximately 2.4% of infants.
median_adult_vol
prop_inf_harvest_adultcut
prop_adult_harvest_adultcut
```

(6)(d) Next, we will create a plot showing the infant conserved proportions (i.e. "not harvested," the prop.infants vector) and the adult conserved proportions (i.e. prop.adults) as functions of volume.value. We will add vertical A-B lines and text annotations for the three (3) "rules" considered, thus far:  "protect all infants," "median infant" and "median adult." Your plot will have two (2) curves - one (1) representing infant and one (1) representing adult proportions as functions of volume.value - and three (3) A-B lines representing the cutoffs determined in (6)(b) and (6)(c).

```{r Part_6d, fig.width = 12, fig.height = 6}
# Grid of candidate cutoffs
volume.value <- seq(min(mydata$VOLUME), max(mydata$VOLUME), length.out = 10000)

# Proportion NOT harvested at cutoff c is P(VOLUME <= c) = ECDF(c)
prop.infants <- ecdf(mydata$VOLUME[idxi])(volume.value)   # conserved infants
prop.adults  <- ecdf(mydata$VOLUME[idxa])(volume.value)   # conserved adults

# Three rules for cutoffs
cut_protect_all <- max(mydata$VOLUME[idxi])      # largest infant volume
cut_median_inf  <- median(mydata$VOLUME[idxi])   # median infant volume
cut_median_ad   <- median(mydata$VOLUME[idxa])   # median adult volume

# Plot 
op <- par(mar = c(4.2, 5, 3.2, 10), xpd = NA)
plot(volume.value, prop.infants, type = "l", lwd = 2.5, col = "blue",
     ylim = c(0, 1), xlab = "VOLUME cutoff", ylab = "Proportion conserved (not harvested)",
     main = "Conserved proportions vs cutoff (Infants & Adults)")

lines(volume.value, prop.adults, lwd = 2.5, col = "red")

# Vertical A–B lines for the 3 rules
abline(v = cut_protect_all, col = "blue", lty = 2, lwd = 2)
abline(v = cut_median_inf,  col = "blue", lty = 3, lwd = 2)
abline(v = cut_median_ad,   col = "blue", lty = 4, lwd = 2)

# Text annotations (nudged above top)
y_top <- 1.02
text(cut_protect_all, y_top, labels = "Protect all infants", pos = 3, srt = 90, cex = 0.85)
text(cut_median_inf,  y_top, labels = "Median infant",      pos = 3, srt = 90, cex = 0.85)
text(cut_median_ad,   y_top, labels = "Median adult",       pos = 3, srt = 90, cex = 0.85)

# Legend
legend("right", inset = c(-0.22, 0), bty = "n",
       legend = c("Infants conserved", "Adults conserved",
                  "Protect all infants", "Median infant", "Median adult"),
       col    = c("blue", "red", rep("gray", 3)),
       lwd    = c(2.5, 2.5, 2, 2, 2),
       lty    = c(1, 1, 2, 3, 4),
       title  = "Curves & Cutoffs")

par(op)


```

**Essay Question:  The two 50% "median" values serve a descriptive purpose illustrating the difference between the populations. What do these values suggest regarding possible cutoffs for harvesting?** 

***Answer: The two 50% "median" values are descriptive benchmarks that highlight the separation between infant and adult populations by volume. The median infant volume suggests that if this value were chosen as a cutoff, approximately half of the infants and over 90% of the adults would be harvested. This indicates that infant and adult volume distributions overlap considerably. The median adult volume, in contrast, results in harvesting about half the adults while conserving nearly all infants. Together, these values suggest that infants tend to occupy the lower range of volumes and adults the higher, but the overlap makes it impossible to set a cutoff that both fully protects infants and still allows for a large harvest of adults. Instead, managers must balance conservation and harvest goals, with the "protect all infants" rule being the most conservative and the "median cutoffs" illustrating how trade-offs look when each group’s central tendency is used.***

-----


More harvest strategies:

This part will address the determination of a cutoff volume.value corresponding to the observed maximum difference in harvest percentages of adults and infants. In other words, we want to find the volume value such that the vertical distance between the infant curve and the adult curve is maximum. To calculate this result, the vectors of proportions from item (6) must be used. These proportions must be converted from "not harvested" to "harvested" proportions by using (1 - prop.infants) for infants, and (1 - prop.adults) for adults. The reason the proportion for infants drops sooner than adults is that infants are maturing and becoming adults with larger volumes.

Note on ROC:

There are multiple packages that have been developed to create ROC curves. However, these packages - and the functions they define - expect to see predicted and observed classification vectors. Then, from those predictions, those functions calculate the true positive rates (TPR) and false positive rates (FPR) and other classification performance metrics. Worthwhile and you will certainly encounter them if you work in R on classification problems.
However, in this case, we already have vectors with the TPRs and FPRs. Our adult harvest proportion vector, (1 - prop.adults), is our TPR. This is the proportion, at each possible 'rule,' at each hypothetical harvest threshold (i.e. element of volume.value), of individuals we will correctly identify as adults and harvest. Our FPR is the infant harvest proportion vector, (1 - prop.infants). We can think of TPR as the Confidence level (ie 1 - Probability of Type I error and FPR as the Probability of Type II error. At each possible harvest threshold, what is the proportion of infants we will mistakenly harvest?
Our ROC curve, then, is created by plotting (1 - prop.adults) as a function of (1 - prop.infants). In short, how much more 'right' we can be (moving upward on the y-axis), if we're willing to be increasingly wrong; i.e. harvest some proportion of infants (moving right on the x-axis)?


-----

***#### Section 7: (10 points)  ####***

(7)(a) Evaluate a plot of the difference ((1 - prop.adults) - (1 - prop.infants)) versus volume.value. Compare to the 50% "split" points determined in (6)(a). There is considerable variability present in the peak area of this plot. The observed "peak" difference may not be the best representation of the data. One solution is to smooth the data to determine a more representative estimate of the maximum difference.

```{r Part_7a}
# Difference between harvest proportions
diff.harvest <- (1 - prop.adults) - (1 - prop.infants)

plot(volume.value, diff.harvest, type = "l", col = "purple",
     xlab = "VOLUME cutoff", ylab = "Difference in harvest proportions",
     main = "Harvest Advantage (Adults - Infants)")

# Add verticals for the three rules
abline(v = max_inf_vol, lty = 2, col = "blue")     # Protect all infants
abline(v = median(mydata$VOLUME[mydata$TYPE == "I"]), lty = 3, col = "green") # Median infant
abline(v = median(mydata$VOLUME[mydata$TYPE == "ADULT"]), lty = 4, col = "red")   # Median adult

legend("topright",
       legend = c("Protect all infants", "Median infant", "Median adult"),
       col = c("blue", "green", "red"),
       lty = c(2,3,4), cex = 0.8)


```

(7)(b) Since curve smoothing is not studied in this course, code is supplied below. Execute the following code to create a smoothed curve to append to the plot in (a). The procedure is to individually smooth (1-prop.adults) and (1-prop.infants) before determining an estimate of the maximum difference. 

```{r Part_7b}

y.loess.a <- loess(1 - prop.adults ~ volume.value, span = 0.25,
	family = c("symmetric"))
y.loess.i <- loess(1 - prop.infants ~ volume.value, span = 0.25,
	family = c("symmetric"))
smooth.difference <- predict(y.loess.a) - predict(y.loess.i)

```

(7)(c) Present a plot of the difference ((1 - prop.adults) - (1 - prop.infants)) versus volume.value with the variable smooth.difference superimposed. Determine the volume.value corresponding to the maximum smoothed difference (Hint:  use *which.max()*). Show the estimated peak location corresponding to the cutoff determined.

Include, side-by-side, the plot from (6)(d) but with a fourth vertical A-B line added. That line should intercept the x-axis at the "max difference" volume determined from the smoothed curve here.

```{r Part_7c, fig.width = 12, fig.height = 6}
# Raw difference (unsmoothed)
raw.difference <- (1 - prop.adults) - (1 - prop.infants)

# Locate the cutoff at the maximum smoothed difference
imax <- which.max(smooth.difference)
cutoff_maxdiff <- volume.value[imax]

# Plot side-by-side
op <- par(mfrow = c(1, 2), mar = c(4.5, 5, 3, 1))

## Left: raw vs smoothed difference
plot(volume.value, raw.difference, type = "l", col = "gray", lwd = 2,
     xlab = "VOLUME cutoff", ylab = "Adult conserved - Infant conserved",
     main = "Difference in conserved proportions")
lines(volume.value, smooth.difference, col = "blue", lwd = 3)
abline(v = cutoff_maxdiff, col = "red", lty = 2, lwd = 2)
mtext(sprintf("Max smoothed diff @ %.1f", cutoff_maxdiff), side = 3, line = 0.5, col = "red")
legend("topleft",
       c("Raw difference", "Smoothed difference", "Max smoothed diff"),
       col = c("gray", "blue", "red"),
       lty = c(1,1,2), lwd = c(2,3,2), bty = "n")

## Right: conserved proportions with all 4 rules
plot(volume.value, prop.infants, type = "l", lwd = 2.5, col = "blue",
     ylim = c(0, 1), xlab = "VOLUME cutoff", ylab = "Proportion conserved (not harvested)",
     main = "Conserved proportions vs cutoff (Infants & Adults)")

lines(volume.value, prop.adults, lwd = 2.5, col = "red")

## 3 prior rules:
abline(v = cut_protect_all,      col = "orange",      lty = 2, lwd = 2)  # Protect all infants
abline(v = cut_median_inf,   col = "purple",      lty = 3, lwd = 2)  # Median infant
abline(v = cut_median_ad, col = "pink",      lty = 4, lwd = 2)  # Median adult
## New 4th rule from max smoothed difference:
abline(v = cutoff_maxdiff,   col = "green",  lty = 2, lwd = 2)

legend("bottomright",
       c("Infants conserved", "Adults conserved",
         "Protect all infants", "Median infant", "Median adult",
         "Max smoothed diff"),
       col = c("blue", "red", "orange", "purple", "pink", "green"),
       lty = c(1,1,2,3,4,2), lwd = c(2,2,2,2,2,2), bty = "n")

par(op)

## Report the cutoff numerically:
cutoff_maxdiff

```

(7)(d) What separate harvest proportions for infants and adults would result if this cutoff is used? Show the separate harvest proportions. We will actually calculate these proportions in two ways:  first, by 'indexing' and returning the appropriate element of the (1 - prop.adults) and (1 - prop.infants) vectors, and second, by simply counting the number of adults and infants with VOLUME greater than the vlume threshold of interest.

Code for calculating the adult harvest proportion using both approaches is provided.

```{r Part_7d}

(1 - prop.adults)[which.max(smooth.difference)]  # [1] 0.7416332
# OR,
sum(mydata[mydata$TYPE == "ADULT", "VOLUME"] >
      volume.value[which.max(smooth.difference)]) / total.adults # [1] 0.7416332

```

-----

There are alternative ways to determine cutoffs. Two such cutoffs are described below.

-----

***####  Section 8: (10 points)  ####***

(8)(a) Harvesting of infants in CLASS "A1" must be minimized. The smallest volume.value cutoff that produces a zero harvest of infants from CLASS "A1" may be used as a baseline for comparison with larger cutoffs. Any smaller cutoff would result in harvesting infants from CLASS "A1."  

Compute this cutoff, and the proportions of infants and adults with VOLUME exceeding this cutoff. Code for determining this cutoff is provided. Show these proportions. You may use either the 'indexing' or 'count' approach, or both.

```{r Part_8a}

zero_A1_cut <- volume.value[volume.value > max(mydata[mydata$CLASS == "A1" &
  mydata$TYPE == "I", "VOLUME"])][1] # [1] 206.786

```

(8)(b) Next, append one (1) more vertical A-B line to our (6)(d) graph. This time, showing the "zero A1 infants" cutoff from (8)(a). This graph should now have five (5) A-B lines:  "protect all infants," "median infant," "median adult," "max difference" and "zero A1 infants."

```{r Part_8b, fig.width = 12}

# Redraw plot
op <- par(mar = c(4.2, 5, 3.2, 1))  # set margins

plot(volume.value, prop.infants, type = "l", lwd = 2.5, col = "blue",
     ylim = c(0, 1),
     xlab = "VOLUME cutoff",
     ylab = "Proportion conserved (not harvested)",
     main = "Conserved proportions vs cutoff (Infants & Adults)")

lines(volume.value, prop.adults, lwd = 2.5, col = "red")

# 5 vertical A–B lines
abline(v = cut_protect_all, col = "orange", lty = 2, lwd = 2)   # Protect all infants
abline(v = cut_median_inf,  col = "purple", lty = 3, lwd = 2)   # Median infant
abline(v = cut_median_ad,   col = "pink",   lty = 4, lwd = 2)   # Median adult
abline(v = cutoff_maxdiff,  col = "green",  lty = 2, lwd = 2)   # Max smoothed diff
abline(v = zero_A1_cut,     col = "black",  lty = 5, lwd = 2)   # Zero A1 infants

# Update legend to include the 5th rule
legend("bottomright",
       c("Infants conserved", "Adults conserved",
         "Protect all infants", "Median infant", "Median adult",
         "Max smoothed diff", "Zero A1 infants"),
       col = c("blue", "red", "orange", "purple", "pink", "green", "black"),
       lty = c(1,1,2,3,4,2,5), lwd = 2, bty = "n")

par(op)
```


***#### Section 9: (5 points) ####***

(9)(a) Construct an ROC curve by plotting (1 - prop.adults) versus (1 - prop.infants). Each point which appears corresponds to a particular volume.value. Show the location of the cutoffs determined in (6), (7) and (8) on this plot and label each. 

```{r Part_9, fig.width = 8.5}

# Construct ROC curve: (1 - prop.adults) vs (1 - prop.infants)
plot(1 - prop.infants, 1 - prop.adults, type = "l", lwd = 2,
     xlab = "Proportion of infants harvested",
     ylab = "Proportion of adults harvested",
     main = "ROC-style Curve: Harvest tradeoff")

# Mark the 5 cutoff rules
points(1 - prop.infants[which.min(abs(volume.value - cut_protect_all))],
       1 - prop.adults[which.min(abs(volume.value - cut_protect_all))],
       col = "orange", pch = 19, cex = 1.3)
text(1 - prop.infants[which.min(abs(volume.value - cut_protect_all))],
     1 - prop.adults[which.min(abs(volume.value - cut_protect_all))],
     labels = "Protect all infants", pos = 4, col = "orange")

points(1 - prop.infants[which.min(abs(volume.value - cut_median_inf))],
       1 - prop.adults[which.min(abs(volume.value - cut_median_inf))],
       col = "purple", pch = 19, cex = 1.3)
text(1 - prop.infants[which.min(abs(volume.value - cut_median_inf))],
     1 - prop.adults[which.min(abs(volume.value - cut_median_inf))],
     labels = "Median infant", pos = 4, col = "purple")

points(1 - prop.infants[which.min(abs(volume.value - cut_median_ad))],
       1 - prop.adults[which.min(abs(volume.value - cut_median_ad))],
       col = "pink", pch = 19, cex = 1.3)
text(1 - prop.infants[which.min(abs(volume.value - cut_median_ad))],
     1 - prop.adults[which.min(abs(volume.value - cut_median_ad))],
     labels = "Median adult", pos = 4, col = "pink")

points(1 - prop.infants[which.min(abs(volume.value - cutoff_maxdiff))],
       1 - prop.adults[which.min(abs(volume.value - cutoff_maxdiff))],
       col = "green", pch = 19, cex = 1.3)
text(1 - prop.infants[which.min(abs(volume.value - cutoff_maxdiff))],
     1 - prop.adults[which.min(abs(volume.value - cutoff_maxdiff))],
     labels = "Max diff", pos = 4, col = "green")

points(1 - prop.infants[which.min(abs(volume.value - zero_A1_cut))],
       1 - prop.adults[which.min(abs(volume.value - zero_A1_cut))],
       col = "black", pch = 19, cex = 1.3)
text(1 - prop.infants[which.min(abs(volume.value - zero_A1_cut))],
     1 - prop.adults[which.min(abs(volume.value - zero_A1_cut))],
     labels = "Zero A1 infants", pos = 4, col = "black")

```

(9)(b) Numerically integrate the area under the ROC curve and report your result. This is most easily done with the *auc()* function from the "flux" package.   Areas-under-curve, or AUCs, greater than 0.8 are taken to indicate good discrimination potential. 

```{r Part_9b}
#install.packages("flux")

library(flux)

# Define x (infants harvested) and y (adults harvested)
x_vals <- 1 - prop.infants
y_vals <- 1 - prop.adults

# Compute AUC
roc_auc <- auc(x_vals, y_vals)
roc_auc

```


***#### Section 10: (10 points) ####***

(10)(a) Prepare a table showing each cutoff along with the following:
 	1) true positive rate (1-prop.adults,
 	2) false positive rate (1-prop.infants),
 	3) harvest proportion of the total population

To calculate the total harvest proportions, you can use the 'count' approach, but ignoring TYPE; simply count the number of individuals (i.e. rows) with VOLUME greater than a given threshold and divide by the total number of individuals in our dataset.
 	
```{r Part_10} 	

# Define cutoffs
cutoffs <- c(cut_protect_all, cut_median_inf, cut_median_ad, cutoff_maxdiff, zero_A1_cut)
names(cutoffs) <- c("Protect all infants", "Median infant", "Median adult", "Max smoothed diff", "Zero A1 infants")

# Function to calculate metrics
calc_metrics <- function(cutoff) {
  tpr <- sum(mydata$VOLUME[idxa] > cutoff) / total.adults   # Adults harvested
  fpr <- sum(mydata$VOLUME[idxi] > cutoff) / total.infants  # Infants harvested
  total_harvest <- sum(mydata$VOLUME > cutoff) / nrow(mydata)
  return(c(TPR = tpr, FPR = fpr, TotalHarvest = total_harvest))
}

# Apply across cutoffs
results <- t(sapply(cutoffs, calc_metrics))

# Make a nice data frame
results_df <- data.frame(Cutoff = round(cutoffs, 2),
                         round(results, 4))
results_df

```
 	
**Essay Question: Based on the ROC curve, it is evident a wide range of possible "cutoffs" exist. Compare and discuss the five cutoffs determined in this assignment.**   

***Answer: The ROC-style curve and AUC value of 0.867 indicate that VOLUME is a strong discriminator between infants and adults, meaning it can be used effectively to design harvesting rules. Each of the five cutoff rules emphasizes a different tradeoff between protecting infants and maximizing the harvest of adults. 1. Protect all infants: This rule is highly conservative: it guarantees no infants are harvested, but only ~25% of adults are available for harvest. While ethically appealing for infant protection, it results in a low yield of adults and may not be practical for large-scale harvesting. 2. Median infant: This rule cuts through the population aggressively, harvesting almost all adults but at the cost of harvesting about half of the infants. The high infant harvest rate makes it unsustainable, but it shows how the two populations overlap in VOLUME distributions. 3. Median adult: This rule provides a more balanced approach: about half of adults are harvested, while only ~2% of infants are mistakenly taken. It is a practical middle ground that offers a moderately reasonable adult yield while keeping infant mortality low. 4. Max smoothed difference: By maximizing the separation between adult and infant harvest rates, this rule provides a biologically meaningful cutoff. It harvests ~74% of adults while only ~18% of infants, striking a compromise between efficiency and conservation. 5. Zero A1 infants: This rule ensures that none of the youngest infants (A1 class) are harvested, but it allows more of the older infant classes to be taken. The result is a relatively high adult harvest (83%) but also a moderate infant harvest (~29%). Conclusion: The max smoothed difference cutoff stands out as the most effective compromise, offering a high adult harvest with relatively low infant loss. This balance makes it the most promising candidate for practical harvesting guidelines.***



**Final Essay Question:  Assume you are expected to make a presentation of your analysis to the investigators How would you do so?  Consider the following in your answer:**

1. Would you make a specific recommendation or outline various choices and tradeoffs?
2. What qualifications or limitations would you present regarding your analysis?
3. If it is necessary to proceed based on the current analysis, what suggestions would you have for  implementation of a cutoff?  
4. What suggestions would you have for planning future abalone studies of this type? 

***Answer: 1. Instead of making a specific recomendation, I would compare the different models generated to explain the intricacies between harvesting strategies and lightly suggest the smoothed difference cutoff. This way, if the investigators have any extra knowledge or requirements that pertains to the findings, such as a yield minimum, they can share. 2. The analysis shows that VOLUME is useful for discriminating between infants and adults, but the overlap between groups, sampling assumptions, and ecological factors limit the reliability of any single cutoff rule. Harvest guidelines should therefore be interpreted as decision-support tools, not absolute rules, and should be adapted to ecological, ethical, and management realities. 3. I would suggest caution with false positives for the cutoff I suggested, which are at ~18%. 4. I would suggest further classification of abalones by age so that the cutoff can be made more precise.***